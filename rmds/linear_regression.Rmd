---
title: "Linear Regression (TMAs)"
author: "Raven McKnight"
date: "12/3/2019"
output: 
  html_document: 
    toc: true
    toc_float: true
    theme: paper
    code_folding: hide
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(data.table)
library(tigris)
library(ggplot2)
library(leaps)

options(tigris_class = "sf")
options(tigris_use_cache = TRUE)

counties <- c("Anoka", "Carver", "Dakota", "Hennepin", "Ramsey", "Scott", "Washington")
bgs <- block_groups("MN", counties, 2016)

# should find better way to read data from rmd folder
lm_dat <- readRDS('~/Documents/honors/honors-project/data/modeling-dat/lm_dat_scaled.RDS')
```

# Introduction

The simplest model we can fit is a linear regression. This model was inspired by Metro Transit's Transit Market Areas. Here, we'll let $Y_i$ equal the log of average number of weekday boardings per stop in census block group $i$ in 2017. We'll use four basic predictors, inspired by the original Transit Market Areas: population density, employment density, percent of households with no vehicle, and a walkability metric derived from walk isochrones. We also include number of stops made in block group $i$ as a control for level of service. Each variable is scaled for comparison. 


# The Model

```{r}
lm_dat <- lm_dat[!is.na(daily_boards) & !is.na(pop_density) & !is.na(emp_density) & !is.na(perc_no_veh) & !is.na(walkability) & !is.na(log_daily_stops)]
lm_dat[daily_boards_per_stop == 0, daily_boards_per_stop := 0.01]

lm_dat_small <- lm_dat %>% 
  dplyr::select(-c(GEOID, daily_boards_per_stop, sqkm, perc_transit_comm, log_daily_boards, log_daily_stops))

lm1 <- lm((scale(log(daily_boards_per_stop))) ~ pop_density + emp_density + perc_no_veh + walkability + scale(log_daily_stops), lm_dat, na.action = na.exclude)

summary(lm1)
```


# Results

## Predictions 

```{r}
lm_dat$predicted_log_scale_boards <- lm1$fitted.values
ggplot(lm_dat, aes(x=scale(log(daily_boards_per_stop)), y = predicted_log_scale_boards)) +
  geom_point(alpha = 0.5) +
  geom_abline(yintercept = 0, slope = 1) +
  labs(title = "Actual versus fitted") +
  theme_minimal() 
```




## Transit Market Areas
There are several ways we can split this distribution to achieve 5 distinct market areas. However, a map of the continuous estimate is also informative: 

```{r}
lm_dat$resid <- residuals(lm1)
lm_dat_sf <- dplyr::left_join(bgs, lm_dat)

ggplot(lm_dat_sf %>% dplyr::filter(!is.na(predicted_log_scale_boards))) +
  geom_sf(aes(fill = predicted_log_scale_boards), lwd = 0) +
  scale_fill_viridis_c() +
  theme_minimal()
```

Here we can see the "bullseye" pattern we might expect.

## Residuals

```{r}
ggplot(lm_dat_sf %>% dplyr::filter(!is.na(resid))) + 
  geom_sf(aes(fill = resid), lwd = 0) +
  scale_fill_viridis_c() + 
  theme_minimal() +
  labs(title = "residuals")
```

```{r}
library(spdep)
resid_dat <- lm_dat_sf %>%
  dplyr::filter(!is.na(resid))

nb <- poly2nb(resid_dat)
W <- nb2mat(nb, style = "B", zero.policy = TRUE)
listW <- nb2listw(nb, zero.policy = TRUE)

moran.mc(resid_dat$log_daily_boards, listW, nsim = 9999, zero.policy = TRUE)
```

```{r}
moran.mc(resid_dat$resid, listW, nsim = 9999, zero.policy = TRUE) # completely spatially random
```

Moran's I suggests some spatial clustering. The "strength" of clustering is less than we might expect because transit ridership occurs on linear paths rather than in "bullseye" clusters. That said, the observed rank in the Moran simulation above suggests that the remaining clustering is worth addressing with an inherently spatial model!