---
title: "A Spatial Model Direct Demand Model: 2019 Analysis"
output:
  MetroTransitr::metro_html: default
  html_document:
    number_sections: no
    theme: paper
    toc: yes
    toc_float: yes
  pdf_document: default
---
<style type="text/css">
html {
  max-width: 10.5in;
  margin: 1.25in 0.75in;
  font-family: "Calibri", helvetica, sans-serif;
  font-size: 11pt;
}

body { width: 8.5in;
       max-width: 10.5in;
}
</style>

```{r setup, include=FALSE}
library(knitr)
library(shiny)
library(slickR)
knitr::opts_chunk$set(echo = FALSE, fig.align="left", out.width = "100%", out.height = "100%")
```

# Introduction


This document explores the results of a spatial direct demand model of Metro Transit's bus ridership. The model takes the spatial dimension of bus ridership into account and incorporates demographic predictors. This builds on existing methodology by leveraging more of what we know about ridership and the region to predict where ridership will occur. 

The model and analysis presented here provide insight to the likelihood of ridership across space given the existing network. The analysis is conducted at the Census block group level. Ridership is defined as the average number of weekday boardings per block group in 2018. Predictors are from the 2018 American Community Survey (ACS) 5-year estimates and 2017 Longitudinal Employee Household Dynamic Survey (LEHD). The use of demographic predictors allows us to consider where ridership is likely to occur based on known characteristics of the region. 

Bus ridership is inherently spatial. In other words, ridership (or boardings) can only occur at fixed bus stops. However, we intuitively expect neighboring block groups to have similar levels of ridership regardless of specific bus stop placement. For example, we might expect all block groups along the A Line to have similar levels of A Line ridership even though not all of those block groups contain an A Line stop. The model presented here addresses these spatial concerns by introducing spatial autocorrelation and geographic smoothing into the model. In other words, this model smooths estimates between block groups to create more stable and realistic predictions of ridership across space. This spatial component adds nuance to the model and **allows us to see patterns we cannot see in non-spatial models.** 

This document outlines key findings from this model of bus ridership. We discuss specific predictors and improvements over non-spatial models. More extensive motivations and methods are available at the end of the document. 


# Findings

This model was tested with a wide variety of ACS variables. The model presented here uses eleven of the most influential variables tested. Five of these demographic predictors have a positive correlation with ridership. Areas with these characteristics have a higher "propensity for ridership" compared to other block groups. Similarly, the two demographic variables negatively correlated with ridership can be thought of as decreasing an area's propensity for ridership. Below, we describe all eleven variables, including four indicator variables, and their associations with ridership. A table of coefficient estimates is available after this discussion. 

##  Map of ridership 


<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/boardings.png")
```
</div>
</div>

## High Propensity for Ridership

<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/perc_rent.png")
```
</div>
  
<div class = "col-md-4">
<br><br> **Percent renters** is the most influential positive predictor of ridership in this model. It is more than two times as significant as the next most important predictor. This variable tends to be correlated with dense, lower income, and less white areas. Areas with many renters are more tightly clustered around major transit corridors than other density measures, such as employment or population density, making it a powerful predictor of transit ridership. This variable is likely associated with age, income, student status, and so on. 

</div>
  
</div>






<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/log_emp_dens.png")
```
</div>
  
<div class = "col-md-4">
<br><br>**Employment density** is a classic predictor of ridership. Like percent renters, employment density is largely centered on the urban core with decreasing density in inner and outer suburbs. Note that the color scale in the map is logged to account for extreme outliers in downtown Minneapolis and Saint Paul.
</div>
  
</div>

<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/walkability.png")
```
</div>
  
<div class = "col-md-4">
<br><br>**Walkability** is another classic predictor of ridership. The predictor is only slightly less significant than employment density. Here, we define "walkability" as the area of a 10-minute walk isochrone from the population-weighted centroid of each block group. A walk isochrone indicates how far someone can walk along the existing street/sidewalk network in a set amount of time (here, 10 minutes). This predictor is also largely concentrated around the urban core and is slightly overshadowed by the "stronger" predictors above. Note that many rural block groups are missing a walkability value because their population-weighted centroid is far away from the existing street network. For the most part, block groups missing this data are outside of Metro Transit's service area. 
</div>
  
</div>

<div class = "row">
  
<div class = "col-md-8">

```{r}
imgs <- list.files("/Users/raven/Documents/honors/mt-translation/precovid/img/map", pattern="age", full.names = TRUE)
slickR(imgs, height = 500)
```

</div>
  
<div class = "col-md-4">
<br><br>**Percent of residents age 18-34** is equally as significant as walkability. This predictor reflects previous studies and surveys which show that this age group is over-represented in Metro Transit's riders. Note that the map to the left shows this predictor logged for visual clarity. Use the arrows to see raw values. 
</div>
  
</div>



<div class = "row">
  
<div class = "col-md-8">

```{r}
imgs2 <- list.files("/Users/raven/Documents/honors/mt-translation/precovid/img/map", pattern="veh", full.names = TRUE)
slickR(imgs2, height = 500)
```
</div>
  
<div class = "col-md-4">
<br><br>**Percent of households without a vehicle** is slightly less significant than the age variable above. This is another classic predictor of ridership. As above, this map is logged for clarity. Click to see raw values. 
</div>
  
</div>


## Low Propensity for Ridership


<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/estimate_median_hh_income.png")
```
</div>
  
<div class = "col-md-4">
<br><br>**Median household income** is the greatest negative predictor of ridership in this model. It is almost twice as significant as the next most important predictor. The negative relationship here reflects our previous understanding of Metro Transit's ridership, which tends to be more low-income than the background population. Income is inversely related to key positive predictors such as employment density. 
</div>
  
</div>

<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/perc_only_white.png")
```
</div>
  
<div class = "col-md-4">
<br><br>**Percent of residents identified as white alone** by the ACS is the only other negative predictor in this model. This is another predictor derived from previoius studies of Metro Transit's ridership which show that transit riders tend to be more racially diverse than the background population. 
</div>
  
</div>

## Indicators

This model also includes four indicator variables. These variables loosely represent special generators and account for "unusual" block groups. The following indicators are ordered by their significance. 

<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/airport.png")
```
</div>
  
<div class = "col-md-4">
<br><br><br><br><br>The **MSP International** airport has the largest positive affect on ridership. This indicator is used in most models of ridership, including the model underpinning the Metropolitan Council's Transit Market Areas. 
</div>
  
</div>


<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/rail.png")
```
</div>
  
<div class = "col-md-4">
<br><br><br><br><br> Block groups containing a **rail station** also have higher ridership than we would otherwise predict. This is likely due to increased transfers to and from rail lines. 
</div>
  
</div>

<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/college.png")
```
</div>
  
<div class = "col-md-4">
<br><br><br><br><br> We include block groups containing **college or university campuses** as an indicator or dummy variable. These block groups have significantly higher ridership than we would expect due to the student population.  
</div>
  
</div>

<div class = "row">
  
<div class = "col-md-8">
```{r}
knitr::include_graphics("/Users/raven/Documents/honors/mt-translation/precovid/img/map/hospital.png")
```
</div>
  
<div class = "col-md-4">
<br><br><br><br><br> Finally, block groups with **hospitals** have higher-than-expected ridership. This is particularly notable in light of COVID-19 and Metro Mobility's essential health care worker rides. 
</div>
  
</div>

## Improvement over Non-Spatial Models

A key finding of this analysis is that spatial models allow us to see different, more nuanced patterns than we find with non-spatial models. In other words, the relationship between predictors and ridership change when we account for spatial correlation. Broadly, we see two types of changes: 


**1. Predictors which are *less* important in spatial models**  
Predictors which become less important in a spatial model often capture spatial patterns themselves. Population density is a prime example of such a predictor. Population density is included in practically all models of transit ridership because we know ridership can only exist where there is a sufficient density of people. However, in the model presented here, when population density is included as a predictor, it receives a coefficient estimate of approximately zero. When we use spatial models, we can focus less on "prerequisite" predictors like density because we rely less on them to define spatial patterns.


**2. Predictors which are *more* important in spatial models**  
The explanation for predictors which are more significant in spatial models is slightly more nuanced. These variables are inefficient at predicting ridership over a large area (for example, the 7 County Metro Area) but can be useful in smaller areas with more things held constant. One example is median household income. We might assume that low-income areas will have higher ridership than high-income areas. However, a low-income area far away from transit will likely have lower ridership than a high-income area close to transit. The spatial model presented here allows us to see that higher median income *is* associated with lower ridership, but only when spatial characteristics are taken into consideration. 

A third, more minor change of note, is that indicator variables become more signiciant in spatial models because geographic smoothing encourages underestimates in "unusual" block groups. 

Between these types of change, spatial models can show entirely different patterns than their non-spatial counterparts. Often, the conclusions from spatial models are more consistent with our understanding of ridership (for example, median household income). 


# Coefficient Estimates

The table below shows complete parameter estimates from a non-spatial model ($\hat\beta_{ns}$) **and** it's spatial counterpart ($\hat\beta_s$).


| Variable | Meaning                                        | $\hat\beta_{ns}$    |$\hat\beta_s$    |
|----------|------------------------------------------------|---------------------|-----------------|
| $x_1$    | Employment density                             | 0.08                | 0.07            |
| $x_2$    | Walkability                                    | 0.07                | 0.06            |
| $x_3$    | Percent of households with no vehicle          | 0.09                | 0.04            |
| $x_4$    | Percent of residents aged 18 to 34             | 0.09                | 0.06            |
| $x_5$    | Presence of college or university campus       | 0.19                | 0.32            |
| $x_6$    | Presence of rail station                       | 0.15                | 0.36            |
| $x_7$    | Presence of hospital campus                    | 0.11                | 0.23            |
| $x_8$    | Presence of MSP International Airport          | 0.04                | 0.52            |
| $x_9$    | Median household income                        | -0.04               | -0.10           |
| $x_{10}$ | Percent of housing units occupied by renters   | 0.17                | 0.15            |
| $x_{11}$ | Percent of residents identified as white alone | -0.06               | -0.06           |



# Motivation

There are several specific motivations for fitting spatial, demographic models of ridership. First, there is evidence to suggest that demographic predictors beyond simple population density may be informative in predicting bus ridership. Previous studies of Metro Transit's ridership have shown that transit riders tend to be more diverse than the background population in terms of race, income, age, and so on (Metro Transit, 2019). While it is challenging to collect demographics from individual bus riders, we can leverage demographic characteristics of the Twin Cities to predict areas of high ridership. 

Including spatial information has other benefits. One primary goal of spatial modeling is to conduct geographic smoothing. In existing methods, such as the process used to determine Transit Market Areas, a model is fit and used to make predictions which are later smoothed using Geographic Information Systems (GIS). This method necessarily sacrifices some granularity in predictions. The model presented here integrates spatial information into the structure of the model itself. This may be particularly helpful in the case of bus ridership data because boardings can only occur at existing bus stops. Geographic smoothing via spatial models can help make predictions in block groups with no existing bus stops and avoid overfitting outliers. 

Census geography itself is a limitation in modeling bus ridership. Geographies such as block groups tend to be bounded by major roadways. Unfortunately, bus routes tend to lie on those same roadways. Because of these bounds, bus stops may be split into block groups counterintuitively. For example, bus stops on either side of the same street traveling in opposite directions are often aggregated into different block groups. The full implications of this limitation are not explored in this study, but some work has been done to define "transit-specific geographies" which could alleviate this problem (Viggiano, 2017). In this study, we use spatial smoothing via modeling to mitigate bounding issues.

**In short, the motivations for this type of modeling are (1) to leverage more of what we know about ridership and our region and (2) to conduct geographic smoothing to handle known challenges with transit data.**


# Methods

This document provides a brief outline of the methodology used in this analysis. More detailed descriptions of the general methodology are available in Morris et al (2019) and Riebler et al (2016). 

The model used in this analysis is a *spatial Bayesian* model. Bayesian models incorporate prior information and produce distributions rather than point estimates as predictions. As described above, the spatial component is included to perform spatial smoothing. Specifically, the spatial aspect of this model accounts for spatial autocorrelation and adjusts predictions in individual block groups based on values in neighboring block groups. 

The specific model used is a reparameterized Besag-York-Mollie (BYM) model. The BYM has similar structure to a classic Bayesian Poisson regression wherein the response variable is assumed to follow a Poisson distribution determined by a set of predictors: 

$$
\begin{align}
Y_i &\sim \text{Poisson}(E_i \lambda_i) \\
\text{log}(\lambda_i) &= \beta_1 x_1 + \beta_2x_2 + \ldots + \beta_n x_n + \varepsilon_i)
\end{align}
$$

In this notation, $Y_i$ is the response variable (ridership) in block group $i$. Each $x$ is a predictor (for example, employment density), each $\beta$ is the corresponding coefficient, and $\varepsilon_i$ is an error term for each block group. Above,"non-spatial model" refers to this type of Poisson regression. The BYM replaces $\varepsilon_i$ with two terms: non-spatial errors $\theta_i$ and spatial errors $\phi_i$ such that

$$
\begin{align}
Y_i &\sim \text{Poisson}(E_i \lambda_i) \\
\text{log}(\lambda_i) &= \beta_1 x_1 + \beta_2x_2 + \ldots + \beta_n x_n + \theta_i + \phi_i)
\end{align}
$$

The term $\phi_i$ is determined based on an adjacency matrix $W$ which encodes spatial relationships between block groups. For block groups $i$ and $j$, entry $w_{ij} = 1$ if block groups $i$ and $j$ share a boundary and $0$ if they do not. This is how spatial information comes into the model and adjusts predictions based on neighbors. More on this matrix and the definition of $\phi_i$ is available in the resources cited above. 

The specific model used in this analysis is a reparameterization of the classic BYM model above called the BYM2. The BYM2 retains the structure of the BYM but is significantly more computationally efficient to fit. The model is fit using Stan via the `rstan` R package. 

# Citations

Metro Transit. 2019. “Transit System Performance Evaluation”. https://metrocouncil.org/ Transportation/Publications-And-Resources/Transit/2019-Transit-System-Performance- Evaluation.aspx.

Morris, Mitzi, et al. 2019. “Bayesian hierarchical spatial models: Implementing the Besag York Molli ́e model in stan”. Spatial and Spatio-temporal Epidemiology 31 (). issn: 1877-5845, visited on 04/03/2020. doi:10.1016/j.sste.2019.100301. http://www.sciencedirect.com/science/ article/pii/S1877584518301175.

Riebler, Andrea, et al. 2016. “An intuitive Bayesian spatial model for disease mapping that accounts for scaling”. Statistical methods in medical research 25 (4): 1145–1165.

Viggiano, Cecilia A. (Cecilia Ann). 2017. “Bus network sketch planning with origin-destination travel data”. Thesis, Massachusetts Institute of Technology. Visited on 04/03/2020. https: //dspace.mit.edu/handle/1721.1/111441.